{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Cloud Formation template for application stack creation - csye6225 summer 19",

    "Parameters" : {
        "stackName":{
            "Type":"String"
        },
        "KeyName":{
            "Type":"String"
        },
        "ImageId":{
            "Type":"String"
        },
        "InstanceType":{
            "Type":"String"
        },
        "VPCID":{
            "Type":"String"
        },
        "webAppSubnetID" : {
            "Type" : "String"
        },
        "dbSubnetID" : {
            "Type" : "String"
        },
        "SecurityGroupID" : {
            "Type" : "String"
       }
    },
    "Resources": {
        "csye6225ec2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
               "AssumeRolePolicyDocument": {
                  "Version" : "2012-10-17",
                  "Statement": [ {
                     "Effect": "Allow",
                     "Principal": {
                        "Service": [ "ec2.amazonaws.com" ]
                     },
                     "Action": [ "sts:AssumeRole" ]
                  } ]
                },
               "Path": "/",
               "Policies": [
                {
                  "PolicyName": "s3deployrdsfull",
                  "PolicyDocument": {
                     "Version" : "2012-10-17",
                     "Statement": [ {
                        "Effect": "Allow",
                        "Action": [
                           "s3:*",
                           "codedeploy:*",
                           "rds:*",
                           "ec2:DescribeAccountAttributes",
                           "ec2:DescribeAvailabilityZones",
                           "ec2:DescribeInternetGateways",
                           "ec2:DescribeSecurityGroups",
                           "ec2:DescribeSubnets",
                           "ec2:DescribeVpcAttribute",
                           "ec2:DescribeVpcs"
                        ],
                        "Resource": "*"
                      } ]
                  }
                }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
               "Path": "/",
               "Roles": [ {
                  "Ref": "csye6225ec2Role"
               } ]
            }
        },
        "s3Bucket" : {
            "Type" : "AWS::S3::Bucket",
            "Properties" : {
              "BucketName" : "csye6225-su19-haridasb-me-csye6225-com",
              "PublicAccessBlockConfiguration" : {
                "BlockPublicAcls" : "true",
                "BlockPublicPolicy" : "true",
                "IgnorePublicAcls" : "true",
                "RestrictPublicBuckets" : "true"
              }
            }
         }, 
    "DBSubnetGroup":{
            "Type":"AWS::RDS::DBSubnetGroup",
            "Properties":{
               "DBSubnetGroupDescription":"description",
               "SubnetIds":[
                  {
                     "Ref":"webAppSubnetID"
                  },
                  {
                     "Ref":"dbSubnetID"
                  }
               ]
            }
    },
    "RDSSecurityGroup":{
        "Type": "AWS::RDS::DBSecurityGroup",
        "Properties": {
            "GroupDescription" : "security group for rds",
            "DBSecurityGroupIngress": {
                "EC2SecurityGroupId": { "Ref": "SecurityGroupID" }
            },
            "EC2VpcId" : { "Ref" : "VPCID" },
            "Tags": [
                {
                    "Key": "Name",
                    "Value": "csye6225-rds"
                }
            ]
        }
    },
    "Ec2Instance" : {
        "Type" : "AWS::EC2::Instance",
        "Properties" : {
          "ImageId" : { "Ref" : "ImageId" },
          "KeyName" : { "Ref" : "KeyName" },
          "InstanceType" : {"Ref" : "InstanceType"},
          "IamInstanceProfile" : {"Ref" : "EC2InstanceProfile"},
          "NetworkInterfaces": [ {
            "AssociatePublicIpAddress": "true",
            "DeviceIndex": "0",
            "GroupSet": [{ "Ref" : "SecurityGroupID" }],
            "SubnetId": { "Ref" : "webAppSubnetID" }
          } ],
          "BlockDeviceMappings" : [
            {
               "DeviceName" : "/dev/sdm",
               "Ebs" : {
                 "VolumeType" : "gp2",
                 "DeleteOnTermination" : "true",
                 "VolumeSize" : "20"
               }
             }
         ],
         "DisableApiTermination" : "true"
        }
      },
      "DynamoDBTable": {
        "Type" : "AWS::DynamoDB::Table",
        "Properties" : {
            "TableName" : "csye6225",
            "AttributeDefinitions" : [
                {
                    "AttributeName" : "id",
                    "AttributeType" : "S"
                }
            ],
            "KeySchema" : [
                {
                    "AttributeName" : "id",
                    "KeyType" : "HASH"
                }
            ],
            "ProvisionedThroughput" : {
                "ReadCapacityUnits" : "5",
                "WriteCapacityUnits" : "5"
            }
        }
    },
    "RDSIntance" : {
        "Type" : "AWS::RDS::DBInstance",
        "Properties" : {
           "DBName" : "csye6225",
           "DBInstanceClass" : "db.t2.medium",
           "AllocatedStorage": "20",
           "MultiAZ" : "false",
           "Engine" : "MySQL",
           "EngineVersion" : "5.6.37",
           "StorageType" : "gp2",
           "MasterUsername" : "csye6225master",
           "MasterUserPassword" :"csye6225password",
           "DBInstanceIdentifier" : "csye6225-su19",
           "DBSecurityGroups" : [ {"Ref" : "RDSSecurityGroup"}],
           "PubliclyAccessible" : "true",
           "DBSubnetGroupName" : { "Ref" : "DBSubnetGroup" }
        }
    }
}
}