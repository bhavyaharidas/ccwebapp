{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Cloud Formation template for application stack creation - csye6225 summer 19",
  "Parameters": {
    "stackName": {
      "Type": "String"
    },
    "KeyName":{
        "Type": "String"
    },
    "ImageId": {
        "Type": "String"
      },
      "SecurityGroupID": {
        "Type": "String"
      },
      "Img":{
        "Type":"String"
      }
  },
  "Resources": {
          "csye6225ec2Role": {
      "Type": "AWS::IAM::Role",
      "Properties": {
         "AssumeRolePolicyDocument": {
            "Version" : "2012-10-17",
            "Statement": [ {
               "Effect": "Allow",
               "Principal": {
                  "Service": [ "ec2.amazonaws.com" ]
               },
               "Action": [ "sts:AssumeRole" ]
            } ]
          },
         "Path": "/",
         "ManagedPolicyArns" : [ 
           "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
            "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore",
          "arn:aws:iam::aws:policy/AmazonSNSFullAccess"],
         "Policies": [
          {
            "PolicyName": "s3deployrdsfull",
            "PolicyDocument": {
               "Version" : "2012-10-17",
               "Statement": [ {
                  "Effect": "Allow",
                  "Action": [
                     "s3:*",
                     "codedeploy:*",
                     "rds:*",
                     "ec2:DescribeAccountAttributes",
                     "ec2:DescribeAvailabilityZones",
                     "ec2:DescribeInternetGateways",
                     "ec2:DescribeSecurityGroups",
                     "ec2:DescribeSubnets",
                     "ec2:DescribeVpcAttribute",
                     "ec2:DescribeVpcs"
                  ],
                  "Resource": "*"
                } ]
            }
          }
          ]
      }
  },
  "EC2InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
         "Path": "/",
         "Roles": [ {
            "Ref": "csye6225ec2Role"
         } ]
      }
  },
    "asg_launch_config" : {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Properties" : {
         "AssociatePublicIpAddress" : true,
         "BlockDeviceMappings" : [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeType": "gp2",
              "VolumeSize": "16"
            }
          }
        ],  
         "IamInstanceProfile" : {
          "Ref": "EC2InstanceProfile"
        },
         "ImageId" : {"Ref" : "ImageId"},
         
         
         "InstanceType" : "t2.micro",
         
         "KeyName": {
          "Ref": "KeyName"
        },
         
         "SecurityGroups" : [
          {
            "Ref": "SecurityGroupID"
          }
        ],
         "UserData" : {
          "Fn::Base64": {
            "Fn::Join": ["\n",
              [ "#!/bin/bash -xe ",
                "sudo cp /tmp/agent_config.service /etc/systemd/system/",
                "sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/tmp/agent_config.json -s",
                "sudo service agent_config.service start",
                {
                  "Fn::Join": ["",[
                    "sudo bash -c 'echo -e \"--regionName=us-east-1",
                    " --bucketName=",
                    {"Ref":"Img"},
                    " --spring.profile.active=prod",
                    " --spring.datasource.username=csye6225master --spring.datasource.password=csye6225password",
                    " --spring.datasource.url=jdbc:mysql://",
                    {
                      "Fn::GetAtt": [
                        "RDSInstance",
                        "Endpoint.Address"
                      ]
                    },
                      ":3306/csye6225?serverTimezone=UTC&createDatabaseIfNotExist=true\" > /usr/lib/envVar.txt'"
                  ]]
                }
        ] ]}}
      }
    },
    "ASGroup" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
         "AutoScalingGroupName" : "csye-6225-asg",
         "Cooldown" : "60",
         "DesiredCapacity" : "3",
         "LaunchConfigurationName" : {"Ref" : "asg_launch_config"},
         "TargetGroupARNs" : [ { "Ref" : "ELBTargetGroup" } ],
         "MaxSize" : "7",
         "MinSize" : "3",
         "Tags" : [
          {
            "Key": "Name",
            "Value": "EC2Instance",
            "PropagateAtLaunch" : true
          }
        ],
         "VPCZoneIdentifier" : [ {"Ref": "webAppSubnetID"} ]
      }
   },

  "WebServerScaleUpPolicy": {
    "Type": "AWS::AutoScaling::ScalingPolicy",
    "Properties": {
      "AdjustmentType": "ChangeInCapacity",
      "AutoScalingGroupName": {
        "Ref": "WebServerGroup"
      },
      "Cooldown": "60",
      "ScalingAdjustment": "1"
    }
  },
  "WebServerScaleDownPolicy": {
    "Type": "AWS::AutoScaling::ScalingPolicy",
    "Properties": {
      "AdjustmentType": "ChangeInCapacity",
      "AutoScalingGroupName": {
        "Ref": "WebServerGroup"
      },
      "Cooldown": "60",
      "ScalingAdjustment": "-1"
    }
  },
  "CPUAlarmHigh": {
    "Type": "AWS::CloudWatch::Alarm",
    "Properties": {
      "AlarmDescription": "Scale-up if CPU > 90% for 10 minutes",
      "MetricName": "CPUUtilization",
      "Namespace": "AWS/EC2",
      "Statistic": "Average",
      "Period": "300",
      "EvaluationPeriods": "2",
      "Threshold": "90",
      "AlarmActions": [
        {
          "Ref": "WebServerScaleUpPolicy"
        }
      ],
      "Dimensions": [
        {
          "Name": "AutoScalingGroupName",
          "Value": {
            "Ref": "WebServerGroup"
          }
        }
      ],
      "ComparisonOperator": "GreaterThanThreshold"
    }
  },
  "CPUAlarmLow": {
    "Type": "AWS::CloudWatch::Alarm",
    "Properties": {
      "AlarmDescription": "Scale-down if CPU < 70% for 10 minutes",
      "MetricName": "CPUUtilization",
      "Namespace": "AWS/EC2",
      "Statistic": "Average",
      "Period": "300",
      "EvaluationPeriods": "2",
      "Threshold": "70",
      "AlarmActions": [
        {
          "Ref": "WebServerScaleDownPolicy"
        }
      ],
      "Dimensions": [
        {
          "Name": "AutoScalingGroupName",
          "Value": {
            "Ref": "WebServerGroup"
          }
        }
      ],
      "ComparisonOperator": "LessThanThreshold"
    }
  },
  "LoadBalancer" : {
    "Type" : "AWS::ElasticLoadBalancingV2::LoadBalancer",
    "Properties" : {    
      
      "Name" : "myELB",
      "Scheme" : "internet-facing",
      "Subnets" : [
        {"Fn::ImportValue" : "csye6225-Networking-web-subnet"},
         {"Fn::ImportValue" : "csye6225-Networking-web-subnet2"}
        ],
      "SecurityGroups" : [{"Fn::ImportValue" : "csye6225-Networking-elb-security-group"}],
      "Type" : "application",
      
      "IpAddressType" : "ipv4"
    }
  }
  }
}